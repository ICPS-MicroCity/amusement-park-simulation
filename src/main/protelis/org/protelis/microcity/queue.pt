module org:protelis:microcity:queue

def isGuest() = env.has("guest")
def isInQueue() = env.get("inQueue") == true

def position() = self.getDevicePosition()
def id() = self.getDeviceUID().getId()

def destination() = env.get("destination")

def destinationTuple() =
    if (isGuest()) {
        if (isInQueue()) {
            [[id(), destination()]]
        } else {
            []
        }
    } else {
        []
    }

share (field <- destinationTuple()) {
    let queue = foldUnion(nbr(destinationTuple())).filter(g -> { g.get(1) == id() }).map(g -> { g.get(0) });
    if (isGuest()) { [] } else { queue }
}
